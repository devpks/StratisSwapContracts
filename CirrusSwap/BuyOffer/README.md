# Buy Offer Contract

A contract used to secure CRS and release after successful transfers of requested SRC token at a specific price.

## Use Case

Johnny wants to buy 10 SRC tokens at .1 CRS each. Johnny creates a new **BuyOffer** contract specifying the token address he wants to buy, how many and at what price (in satoshis). The contract will validate Johnny's inputs and also ensure that he sent enough CRS tokens to cover the buy order. The contract will hold the CRS tokens until the order is filled or Johnny cancels the contract.

## Creating the Contract

### Hash

```text
fa9d2b2072f816ffe79b02bfe162fa8f64c29ceed753fd75f7ca4a55d9a6e10b
```

### ByteCode

```text
4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010200AA9A349C0000000000000000E00022200B013000001000000002000000000000862E0000002000000040000000000010002000000002000004000000000000000400000000000000006000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000342E00004F000000000000000000000000000000000000000000000000000000004000000C000000182E00001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E746578740000008C0E0000002000000010000000020000000000000000000000000000200000602E72656C6F6300000C000000004000000002000000120000000000000000000000000000400000420000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000682E000000000000480000000200050090230000880A000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001330040076000000000000000203280600000A0205166AFE037201000070280700000A020E04166AFE03723B000070280700000A0202280800000A6F0900000A0E0405D9FE0516FE017277000070280700000A0204280300000602052805000006020E0428070000060202280800000A6F0A00000A28090000060217280B0000062A4602280B00000A72BF0000706F0C00000A2A4A02280B00000A72BF000070036F0D00000A2A4602280B00000A72D90000706F0E00000A2A4A02280B00000A72D9000070036F0F00000A2A4602280B00000A72EF0000706F0E00000A2A4A02280B00000A72EF000070036F0F00000A2A4602280B00000A72070100706F0C00000A2A4A02280B00000A7207010070036F0D00000A2A4602280B00000A72130100706F1000000A2A4A02280B00000A7213010070036F1100000A2A001330080042010000010000110202280A0000067225010070280700000A0202280800000A6F0A00000A022808000006281200000A7225010070280700000A0228060000060334080228060000062B0103100102280400000603D90A0202281300000A06FE0516FE017243010070280700000A02022802000006166A728B010070198D0E000001251602280800000A6F0A00000A8C08000001A225170228080000068C08000001A22518038C0F000001A2166A281400000A0B02076F1500000A7225010070280700000A0202280800000A6F0A00000A06281600000A2602280600000603DB0C08166A3609020828070000062B0602280E0000061204FE1503000002120402280800000A6F0A00000A7D0100000412040228040000067D020000041204037D030000041204067D04000004120402281700000A6F1800000A7D0500000411040D0209280100002B092AA20202280800000A6F0A00000A022808000006281A00000A7225010070280700000A02280E0000062A9602281300000A166A36130202280800000602281300000A281600000A260216280B0000062A0000001330020057000000020000111200FE150400000212000228020000067D0600000412000228040000067D0700000412000228060000067D08000004120002281300000A7D09000004120072A50100707D0A000004120002280A0000067D0B000004062A0042534A4201000100000000000C00000076342E302E33303331390000000005006C000000B4030000237E0000200400008C03000023537472696E677300000000AC070000B80100002355530064090000100000002347554944000000740900001401000023426C6F6200000000000000020000015715A201090A000000FA0133001600000100000010000000040000000B0000000F0000000A0000001A000000050000000200000001000000050000000A000000010000000200000002000000010000000000DD0101000000000006002A0173020600690173020600160160020F00930200000A00590103030A001A0303030A00CA0003030A00FB0203030A002F0303030600AF0004020A004A0103030A00900003030A00F100030306002803040206000E0004020A00C70103030000000015000000000001000100010010002D0200001900010001000A0110000B0200002900010010000A011000A502000029000600100006003F029C0006005300A00006005303A00006003500A0000600D201A0000600D3029C0006005300A00006005303A00006007500A0000600A500A3000600BA01A60050200000000086185A02A9000100D220000000008608BE0225000500E420000000008108CF02B3000500F72000000000860840002100060009210000000081084F00B90006001C210000000086083F03210007002E210000000081084F03B9000700412100000000860846022500080053210000000081085002B30008006621000000008608A901710009007821000000008108B601BE0009008C21000000008600EF01C3000A00DA22000000008600850006000B000323000000008100870106000B002C23000000008600A202C9000B0000000100DE0000000200E002000003005E00000004005F0300000100A30100000100A30100000100A30100000100A30100000100A30100000100B90009005A02010011005A02060019005A020A0029005A02060059005A02060031005A02100031006B031600310099001C00610099012100610022022500310002012A006900ED022F006900F8023500690001003C0069000B0041006900F40147006900FC014C0041007E035D003100690021003100D80165004900B20271003100360275003100CE017D008100170221003100C3018200410072035D0021002B000C012E000B00DB002E001300E4002E001B000301430023000C0152008E00020001000000D302CE0000005300D30000005303D30000005402CE000000BA01D70002000200030001000300030002000400050001000500050002000600070001000700070002000800090001000900090002000A000B0001000B000B000480000000000000000000000000000000001A03000004000000000000000000000093001E00000000000100020001000000000000000000030300000000030002000400020033008900000000000047657455496E7436340053657455496E743634003C4D6F64756C653E0053797374656D2E507269766174652E436F72654C696200546F74616C5072696365006765745F546F6B656E5072696365007365745F546F6B656E507269636500746F6B656E5072696365006765745F42616C616E636500436F6E747261637442616C616E636500436C6F7365547261646500494D657373616765006765745F4D657373616765005472616465547970650056616C75655479706500616D6F756E74546F50757263686173650049536D617274436F6E7472616374537461746500736D617274436F6E74726163745374617465004950657273697374656E745374617465006765745F50657273697374656E7453746174650044656275676761626C6541747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500496E646578417474726962757465004465706C6F794174747269627574650052756E74696D65436F6D7061746962696C69747941747472696275746500436C6F7365547261646545786563757465006765745F56616C75650076616C7565006765745F4973416374697665007365745F4973416374697665004C6F670049426C6F636B006765745F426C6F636B0043616C6C00536D617274436F6E74726163742E646C6C0053656C6C00476574426F6F6C00536574426F6F6C0053797374656D005472616E73616374696F6E006765745F4E756D626572006765745F53656E646572004275794F66666572005472616E736665720053656C6C6572006765745F4275796572007365745F4275796572002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F64657300476574547261646544657461696C73006765745F53756363657373006765745F546F6B656E41646472657373007365745F546F6B656E4164647265737300746F6B656E416464726573730047657441646472657373005365744164647265737300537472617469732E536D617274436F6E74726163747300536D617274436F6E7472616374004F626A65637400495472616E73666572526573756C74006765745F546F6B656E416D6F756E74007365745F546F6B656E416D6F756E7400746F6B656E416D6F756E7400417373657274006F705F457175616C697479006F705F496E657175616C6974790000395000720069006300650020006D007500730074002000620065002000670072006500610074006500720020007400680061006E0020003000003B41006D006F0075006E00740020006D007500730074002000620065002000670072006500610074006500720020007400680061006E00200030000047420061006C0061006E006300650020006900730020006E006F007400200065006E006F00750067006800200074006F00200063006F00760065007200200063006F0073007400001954006F006B0065006E004100640064007200650073007300001554006F006B0065006E0050007200690063006500001754006F006B0065006E0041006D006F0075006E007400000B42007500790065007200001149007300410063007400690076006500001D41007300730065007200740020006600610069006C00650064002E0000474E006F007400200065006E006F007500670068002000660075006E0064007300200074006F00200063006F007600650072002000700075007200630068006100730065002E0000195400720061006E007300660065007200460072006F006D0000114200750079004F0066006600650072000000ADD7641300F9904C85305773CAF3F6810004200101080320000105200101111105200101121D05200201020E04200012310320000B0420001121042000123505200111210E062002010E11210420010B0E052002010E0B042001020E052002010E020A07050B12250B110C110C07000202112111210B2005122511210B0E1D1C0B03200002072002122511210B042000124106300101011E00040A01110C0407011110087CEC85D7BEA7798E0306112102060B02060E02060209200401121D11210B0B052001011121042001010B0420010102052001110C0B042000111004280011210328000B032800020801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000200000000000401000000000000000000000000000000000000100000000000000000000000000000005C2E00000000000000000000762E0000002000000000000000000000000000000000000000000000682E0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF2500200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000883E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
```

### Parameters

- `Address tokenAddress` - The contract address of the token for sale.
- `ulong tokenPrice` - The amount of crs per src token in satoshis (e.g. 1crs = 100_000_000).
- `ulong tokenAmount` - The amount of src tokens to sell in full. (e.g. 1 for 1src token)

## Closing the contract

The creator of the contract has abilities to cancel the contract. This sets the `IsActive` flag to false preventing further user interaction.

- Call the `CloseTrade` method on the trade contract address

## Get Trade Details

Prior to attempting to settle a contract, make a local call to `GetTradeDetails` to preview the contracts state. Returns a `TradeDetails` struct.

```csharp
public struct TradeDetails
{
  public Address TokenAddress;   // Address of src token for sale
  public ulong TokenPrice;       // Ask price of each src token
  public ulong TokenAmount;      // Amount of srcToken for sale
  public ulong ContractBalance;  // Balance of CRS on the contract
  public string TradeType;       // Returns "BuyOffer"
  public bool IsActive;          // True if trade is open
}
```

**Note** - Prior to attempting to settle a sell contract, you may also want to make a local call to the src tokens contract to verify that the contract address is approved to send the necessary amount of src tokens. Safe gaurds are in place for the contract isn't properly approved, but gas for calling the contract will be lost.

## Filling a Trade

For buy offers, all trades looking to fill the contract will call the `Sell(ulong amountToPurchase)` method supplying the amount of src tokens they'd like to sell as a parameter.

- Validations are run against contract details and buyer supplied parameters.
- Src token amount is sent to the buyer.
  - Upon success, crs token is transferred to seller.
  - Upon failure, no funds will move.
- Any remaining balance from buyer, return to them
- Check if the `TokenAmount` to sell is 0 or if the contract is not fully filled.
  - If fully filled - close contract, transfer remaining balance back to owner and return `Transaction` result
  - If not full filled - Update `TokenAmount` and return `Transaction` result

```csharp
public struct Transaction
{
    [Index]
    public Address Seller;
    public ulong TokenPrice;  // Price of each src token sold
    public ulong TokenAmount; // Amout of src token sold
    public ulong TotalPrice;  // Total price of transaction
    public ulong Block;       // The block number it was executed on
}
```


