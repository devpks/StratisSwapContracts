# Cirrus Swap
Cirrus Decentralized Exchange Contracts

Consists of two contracts at this time, a Buy Offer contract and a SellOffer contract. 

## Buy Offer Contract

## Sell Offer Contract
Users create these for src token sales.

### Creating the contract

**Hash**

```text
5d6f4269b61ec80ff2911b573a4348323946372485aa0487a41624ca48a6a109
```

**ByteCode**

```text
4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0102000053FBF90000000000000000E00022200B013000000E00000002000000000000722D0000002000000040000000000010002000000002000004000000000000000400000000000000006000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000202D00004F000000000000000000000000000000000000000000000000000000004000000C000000042D00001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000780D000000200000000E000000020000000000000000000000000000200000602E72656C6F6300000C000000004000000002000000100000000000000000000000000000400000420000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000542D000000000000480000000200050060230000A409000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001330030057000000000000000203280600000A0205166AFE037201000070280700000A020E04166AFE03723D000070280700000A020428030000060202280800000A6F0900000A280500000602052809000006020E0428070000060217280B0000062A4602280A00000A72770000706F0B00000A2A4A02280A00000A7277000070036F0C00000A2A4602280A00000A72910000706F0B00000A2A4A02280A00000A7291000070036F0C00000A2A4602280A00000A729F0000706F0D00000A2A4A02280A00000A729F000070036F0E00000A2A4602280A00000A72B50000706F0D00000A2A4A02280A00000A72B5000070036F0E00000A2A4602280A00000A72CD0000706F0F00000A2A4A02280A00000A72CD000070036F1000000A2A133008006F010000010000110202280A00000672DF000070280700000A0202280800000A6F0900000A022804000006281100000A72DF000070280700000A0203022808000006FE0316FE0172DF000070280700000A02280600000603D90A0202280800000A6F1200000A06FE0516FE0172FD000070280700000A02022802000006166A7245010070198D0E00000125160228040000068C08000001A2251702280800000A6F0900000A8C08000001A225180228080000068C0F000001A2166A281300000A0B02076F1400000A72DF000070280700000A0202280400000606281500000A2602280800000A6F1200000A06DB0C08166A36130202280800000A6F0900000A08281500000A2602280800000603DB0D09166A3609020928090000062B070216280B0000061205FE1503000002120502280800000A6F0900000A7D0100000412050228040000067D020000041205037D0300000412050228060000067D040000041205067D0500000411051304021104280100002B11042AA60202280800000A6F0900000A022804000006281700000A72DF000070280700000A0216280B0000062A000000133002003E000000020000111200FE1504000002120002280A0000067D0600000412000228020000067D0900000412000228060000067D0800000412000228080000067D07000004062A000042534A4201000100000000000C00000076342E302E33303331390000000005006C00000080030000237E0000EC0300003C03000023537472696E67730000000028070000600100002355530088080000100000002347554944000000980800000C01000023426C6F6200000000000000020000015715A201090A000000FA013300160000010000000F00000004000000090000000E0000000A00000017000000050000000200000001000000050000000A0000000100000002000000020000000100000000009501010000000000060005011D02060044011D020600F1000A020F003D0200000A003401AD020A00C402AD020A00A500AD020A00A502AD020A00D902AD0206008A00B7010A002501AD020A007500AD020A00CC00AD020600D202B70106000E00B701000000001500000000000100010001001000D50100001900010001000A011000BE010000290001000F000A0110004F020000290006000F000600FE0198000600F70198000600FD029C00060053009C00060035009C00060083019F000600FD029C00060053009C0006007D02980050200000000086180402A2000100B320000000008608680221000500C5200000000081087902AC000500D820000000008608E80121000600EA20000000008108F301AC000600FD200000000086084000620007000F210000000081084F00B20007002221000000008608E902620008003421000000008108F902B2000800472100000000860872017200090059210000000081087F01B70009006C210000000086003603BC000A00E722000000008600690006000B0014230000000086004C02C2000B0000000100B900000002008A02000003000903000004005E00000001006C01000001006C01000001006C01000001006C01000001006C01000001009400090004020100110004020600190004020A0029000402060059000402060031000402100031001503160031007E001C006100CA0121003100DD002600690097022B006900A202310069000100380069000B003D006900A70143006900AF014800410028035A0061006201620031009001660049005C0272003100DF01760031008C017E0041001C035A0021002B0005012E000B00D4002E001300DD002E001B00FC004300230005014E008A000200010000007D02C7000000F701C70000005300CC000000FD02CC0000008301D00002000200030001000300030002000400050001000500050002000600070001000700070002000800090001000900090002000A000B0001000B000B00048000000000000000000000000000000000C40200000400000000000000000000008F001E00000000000100020001000000000000000000AD020000000003000200040002002D00850000000047657455496E7436340053657455496E743634003C4D6F64756C653E0053797374656D2E507269766174652E436F72654C696200546F74616C5072696365006765745F546F6B656E5072696365007365745F546F6B656E507269636500746F6B656E50726963650043616E63656C547261646500494D657373616765006765745F4D6573736167650056616C75655479706500616D6F756E74546F50757263686173650049536D617274436F6E7472616374537461746500736D617274436F6E74726163745374617465004950657273697374656E745374617465006765745F50657273697374656E7453746174650044656275676761626C6541747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500496E646578417474726962757465004465706C6F794174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465006765745F56616C75650076616C7565006765745F4973416374697665007365745F4973416374697665004C6F670043616C6C00536D617274436F6E74726163742E646C6C00476574426F6F6C00536574426F6F6C0053797374656D005472616E73616374696F6E006765745F53656E6465720053656C6C4F66666572005472616E73666572006765745F53656C6C6572007365745F53656C6C6572004275796572002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F64657300476574547261646544657461696C73006765745F53756363657373006765745F546F6B656E41646472657373007365745F546F6B656E4164647265737300746F6B656E416464726573730047657441646472657373005365744164647265737300537472617469732E536D617274436F6E74726163747300536D617274436F6E7472616374004F626A65637400495472616E73666572526573756C74006765745F546F6B656E416D6F756E74007365745F546F6B656E416D6F756E7400746F6B656E416D6F756E7400417373657274006F705F457175616C697479006F705F496E657175616C69747900427579000000003B41006D006F0075006E00740020006D007500730074002000620065002000670072006500610074006500720020007400680061006E002000300000395000720069006300650020006D007500730074002000620065002000670072006500610074006500720020007400680061006E0020003000001954006F006B0065006E004100640064007200650073007300000D530065006C006C0065007200001554006F006B0065006E0050007200690063006500001754006F006B0065006E0041006D006F0075006E007400001149007300410063007400690076006500001D41007300730065007200740020006600610069006C00650064002E0000474E006F007400200065006E006F007500670068002000660075006E0064007300200074006F00200063006F007600650072002000700075007200630068006100730065002E0000195400720061006E007300660065007200460072006F006D000000F8CFFB0F42E4484C93E39268C967761E0004200101080320000105200101111105200101121D05200201020E04200012310420001121042000123505200111210E062002010E11210420010B0E052002010E0B042001020E052002010E020B07060B12250B0B110C110C07000202112111210320000B0B2005122511210B0E1D1C0B03200002072002122511210B06300101011E00040A01110C0407011110087CEC85D7BEA7798E0306112102060B02060209200401121D11210B0B052001011121042001010B0420010102052001110C0B042000111004280011210328000B032800020801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000200000000000401000000000000000000000000000000000010000000000000000000000000000000482D00000000000000000000622D0000002000000000000000000000000000000000000000000000542D0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000743D00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
```

**Parameters** 

- `Address tokenAddress` - The contact address of the token for sale.
- `ulong tokenAmount` - The amount of src tokens to sell in full. (e.g. 1 for 1src token)
- `ulong tokenPrice` - The amount of crs per src token in satoshi amounts (e.g. 1crs = 100_000_000).

**Post Deployment**

After the contract is created the new contract address must be Approved to spend the amount of src tokens specified in the `tokenAmount` parameter.

- Call the `Approve(Address tradeContractAddress, ulong oldBalance, ulong newBalance)` method at the `tokenAddress` of the src tokent to be traded.
  - Supply the new trade contract address to spend up to the `tokenAmount` specified.
- Upon success, the `tradeContract` address will have an allowance that will be used to settle the transaction.

### Cancelling the contract

The creator of the contract has abilities to cancel the contract. This sets the `IsActive` flag to false preventing further user interaction.

- Call the `CloseTrade` method on the trade contract address

### Get Trade Details

Prior to attempting to settle a contract, make a local call to `GetTradeDetails` to preview the contracts state. Returns a `TradeDetails` struct. 

```csharp
public struct TradeDetails
{
  public bool IsActive; // True if trade is open
  public ulong TokenAmount; // Amount of srcToken for sale
  public ulong TokenPrice; // Ask price of each src token
  public Address TokenAddress; // Address of src token for sale
}
```

**Note** - Prior to attempting to settle a sell contract, you may also want to make a local call to the src tokens contract to verify that the contract address is approved to send the necessary amount of src tokens. Safe gaurds are in place for the contract isn't properly approved, but gas for calling the contract will be lost.

### Filling a Trade

Since this is a sell contract, all trades will call the `Buy(ulong amountToPurchase)` method supplying the amount of src tokens they'd like to purchase as a parameter.

- Validations are ran to fail fast prior to settling any part of the trade.
  - Fail fast if necessary
- Src token amount is sent to the buyer.
  - Upon success, crs token is transferred to seller.
  - Upon failure, no funds will move.
- Any remaining balance from buyer, return to them
- Check if the `TokenAmount` to sell is 0 or if the contract is not fully filled.
  - If fully filled - close contract and return `Transaction` result
  - If not full filled - Update `TokenAmount` and return `Transaction` result

```csharp
// Index Buyer for all transactions as Seller value is constant.
public struct Transaction
{
    [Index]
    public Address Buyer;
    public Address Seller;
    public ulong TokenAmount; // Amout of src token sold
    public ulong TokenPrice; // Price of each src token sold
    public ulong TotalPrice; // Total price of transaction
}
```

